<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css"><meta name="keywords" content="Java,多线程编程,生产者消费者问题,"><link rel="alternate" href="/atom.xml" title="崔伟的个人博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1"><meta name="description" content="生产者消费者问题简述生产者消费者问题（英语：Producer-consumer problem），也称有限缓冲问题（英语：Bounded-buffer problem），是一个多线程同步问题的经典案例。该问题描述了两个共享固定大小缓冲区的线程——即所谓的“生产者”和“消费者”——在实际运行时会发生的问题。生产者的主要作用是生成一定量的数据放到缓冲区中，然后重复此过程。与此同时，消费者也在缓冲区消耗"><meta name="keywords" content="Java,多线程编程,生产者消费者问题"><meta property="og:type" content="article"><meta property="og:title" content="JAVA多线程编程——生产者消费者模式(1)"><meta property="og:url" content="http://doornote.net/2016/07/17/java-multithreading-1/index.html"><meta property="og:site_name" content="崔伟的个人博客"><meta property="og:description" content="生产者消费者问题简述生产者消费者问题（英语：Producer-consumer problem），也称有限缓冲问题（英语：Bounded-buffer problem），是一个多线程同步问题的经典案例。该问题描述了两个共享固定大小缓冲区的线程——即所谓的“生产者”和“消费者”——在实际运行时会发生的问题。生产者的主要作用是生成一定量的数据放到缓冲区中，然后重复此过程。与此同时，消费者也在缓冲区消耗"><meta property="og:image" content="http://doornote.net/2016/07/17/java-multithreading-1/1-1.PNG"><meta property="og:image" content="http://doornote.net/2016/07/17/java-multithreading-1/1-2.PNG"><meta property="og:image" content="http://www.plantuml.com/plantuml/svg/XP2z2i9G38Nd-XGP5RNWBWx-e0YYhcun3VNgRLBRMn5AtrrhjOeepP3bV3avd1ZfX243QUGVCeiM_MFa_9W6liQSe3CgUGlkW_lK9KWEo6AQmlgbGYMNqnzRfPEHS9jnniEPPNA9Yg69Hh4AYnl1kPJgYsx-iYtgT-qVTy3KQNbUzw8cW8I9pOKRkK3haErttFBFcqbPWY-n1_-C7x6BnwvAcE9AWQ_kRlBHIFxal0hQeCupbB0HNA0i3JTYkuDP6fJ_N743"><meta property="og:updated_time" content="2016-07-19T09:26:01.941Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="JAVA多线程编程——生产者消费者模式(1)"><meta name="twitter:description" content="生产者消费者问题简述生产者消费者问题（英语：Producer-consumer problem），也称有限缓冲问题（英语：Bounded-buffer problem），是一个多线程同步问题的经典案例。该问题描述了两个共享固定大小缓冲区的线程——即所谓的“生产者”和“消费者”——在实际运行时会发生的问题。生产者的主要作用是生成一定量的数据放到缓冲区中，然后重复此过程。与此同时，消费者也在缓冲区消耗"><meta name="twitter:image" content="http://doornote.net/2016/07/17/java-multithreading-1/1-1.PNG"><script type="text/javascript" id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0,author:"博主"}}</script><link rel="canonical" href="http://doornote.net/2016/07/17/java-multithreading-1/"><title>JAVA多线程编程——生产者消费者模式(1) | 崔伟的个人博客</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div style="display:none"><script src="//s6.cnzz.com/stat.php?id=1259906155&web_id=1259906155" type="text/javascript"></script></div><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">崔伟的个人博客</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">coder,steamer,sleeper....</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline">JAVA多线程编程——生产者消费者模式(1)</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2016-07-17T13:52:07+08:00" content="2016-07-17">2016-07-17 </time></span><span class="post-category">&nbsp; | &nbsp; <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span> </a></span></span><span class="post-comments-count">&nbsp; | &nbsp; <a href="/2016/07/17/java-multithreading-1/#comments" itemprop="discussionUrl"><span class="post-comments-count ds-thread-count" data-thread-key="2016/07/17/java-multithreading-1/" itemprop="commentsCount"></span> </a></span>&nbsp; | &nbsp; <span class="page-pv"><i class="fa fa-file-o"></i> <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="生产者消费者问题简述"><a href="#生产者消费者问题简述" class="headerlink" title="生产者消费者问题简述"></a>生产者消费者问题简述</h2><blockquote><p><strong>生产者消费者问题</strong>（英语：Producer-consumer problem），也称有限缓冲问题（英语：Bounded-buffer problem），是一个多线程同步问题的经典案例。该问题描述了两个共享固定大小缓冲区的线程——即所谓的“生产者”和“消费者”——在实际运行时会发生的问题。生产者的主要作用是生成一定量的数据放到缓冲区中，然后重复此过程。与此同时，消费者也在缓冲区消耗这些数据。该问题的关键就是要保证生产者不会在缓冲区满时加入数据，消费者也不会在缓冲区中空时消耗数据;</p><footer><strong>@Wiki</strong><cite><a href="https://zh.wikipedia.org/wiki/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98" target="_blank" rel="external">zh.wikipedia.org/wiki/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98</a></cite></footer></blockquote><a id="more"></a><p>&ensp;<br>如下图所示：<br>&ensp;<br><img src="/2016/07/17/java-multithreading-1/1-1.PNG" alt="典型的生产者消费者模型" title="典型的生产者消费者模型"></p><h2 id="阻塞队列"><a href="#阻塞队列" class="headerlink" title="阻塞队列"></a>阻塞队列</h2><p>由以上模型可知缓冲区是建立起两个线程之间数据交互的桥梁；通常我们使用队列充当缓冲区，这里便引入<em>阻塞队列</em>的概念：<br></p><blockquote><ul><li><em>阻塞队列</em>（BlockingQueue） 是一个支持两个附加操作的队列。这两个附加的操作是：在队列为空时，获取元素的线程会等待队列变为非空。当队列满时，存储元素的线程会等待队列可用。阻塞 队列常用于生产者和消费者的场景，生产者是往队列里添加元素的线程，消费者是从队列里拿元素的线程。阻塞队列就是生产者存放元素的容器，而消费者也只从容 器里拿元素。</li></ul><footer><strong>@引用来源</strong><cite><a href="http://www.infoq.com/cn/articles/java-blocking-queue/" target="_blank" rel="external">www.infoq.com/cn/articles/java-blocking-queue</a></cite></footer></blockquote><br><!-- more --><p></p><h2 id="简单的泛型阻塞队列的实现"><a href="#简单的泛型阻塞队列的实现" class="headerlink" title="简单的泛型阻塞队列的实现"></a>简单的泛型阻塞队列的实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.hulala.jmt.pc1.pojo;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.LinkedList;</div><div class="line"><span class="keyword">import</span> java.util.Queue;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 队列的实现，支持线程间安全的offer poll操作</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingQueue</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> Queue&lt;T&gt; queue;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlockingQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">        queue = <span class="keyword">new</span> LinkedList&lt;T&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 向队列尾部添加一个对象</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> t</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> res = queue.offer(t);</div><div class="line">        <span class="keyword">this</span>.notify();</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 从队列头部取出一个对象</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> InterruptedException</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title">poll</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (queue.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">this</span>.wait();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.queue.poll();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 返回队列长度</div><div class="line">     * </div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.queue.size();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>代码非常简单，就是通过对Queue对象进行二次封装，这里使用到了synchronized关键字：<br></p><blockquote><p><em>synchronized</em>是Java中的关键字，是一种同步锁。它修饰的对象有以下几种</p><ol><li>修饰一个代码块，被修饰的代码块称为同步语句块，其作用的范围是大括号{}括起来的代码，作用的对象是调用这个代码块的对象；</li><li>修饰一个方法，被修饰的方法称为同步方法，其作用的范围是整个方法，作用的对象是调用这个方法的对象；</li><li>修改一个静态的方法，其作用的范围是整个静态方法，作用的对象是这个类的所有对象；</li><li>修改一个类，其作用的范围是synchronized后面括号括起来的部分，作用主的对象是这个类的所有对象。</li></ol><footer><strong>@引用来源</strong><cite><a href="http://blog.csdn.net/luoweifu/article/details/46613015" target="_blank" rel="external">blog.csdn.net/luoweifu/article/details/46613015</a></cite></footer></blockquote><p></p><h2 id="生产者消费者模式初步实现"><a href="#生产者消费者模式初步实现" class="headerlink" title="生产者消费者模式初步实现"></a>生产者消费者模式初步实现</h2><p>下面来看看利用以上阻塞队列的<em>生产者消费者模型</em>的初步实现：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.hulala.jmt.pc1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.hulala.jmt.pc1.pojo.BlockingQueue;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> BlockingQueue&lt;String&gt; queue = <span class="keyword">new</span> BlockingQueue&lt;String&gt;();</div><div class="line">		<span class="comment">//生产者线程</span></div><div class="line">		Thread cosumer = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				System.out.println(queue.poll());</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		cosumer.start();</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			Thread.sleep(<span class="number">3000</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//消费者线程</span></div><div class="line">		Thread producer = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				queue.offer(<span class="string">"I am here"</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		producer.start();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>执行以上代码，会看到控制台输出：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wait data</div><div class="line">I am here</div></pre></td></tr></table></figure><p></p><p><strong>代码执行流程如下：</strong></p><ul><li>在调用<strong>poll</strong>方法时,在代码块synchronized中会获得当前BlockingQueue实例的对象锁，若队列中无数据，则wait方法会使当前线程进入休眠等待状态，并释放对象锁；</li><li>在调用<strong>offer</strong>方法往队尾部添加数据之后，使用notify会时poll方法所在线程重新获取到当前BlockingQueue实例的对象锁，并继续执行wait方法后的代码；</li><li>以上测试代码即是一个简单的生产者消费者模型，阻塞队列常用场景就是在生产者消费者问题中。</li></ul><h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><p>显而易见的是，实际情况不会像以上例子那么简单，生产者消费者问题，是一个生产者持续产生数据到缓冲区、而消费者持续消耗缓冲区数据的过程；下面我们通过一个例子来说明；<br>现以假设某个电子元件的生产流水线为例：<br>&ensp;<br><img src="/2016/07/17/java-multithreading-1/1-2.PNG" alt="流水线" title="流水线"></p><p>通过上图可以很简单的看出这条流水线由4个流程组成，下面以面向对象的思想分析以上流程：</p><ol><li>4个过程(打磨、抛光、焊接、质检)可抽象为4个操作</li><li>每个操作本身都是相对于前一操作来说是消费者，相对于后一操作来说是生产者；</li><li>每个操作实现不同（打磨、抛光、焊接、质检）</li></ol><p><strong>面向对象编程的思想</strong>要求我们找出对象的共同点在对其封装，对其不同点进行抽象。从以上分析我们已找到异同点，这便足以让我们开始写代码了；</p><p>首先 把电子元件抽象成一个Pojo:<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.hulala.jmt.pc1.pojo;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElectronicComponent</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> code;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ElectronicComponent</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.code = code;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">status</span><span class="params">(String opertion)</span></span></div><div class="line">	&#123;</div><div class="line">		System.out.println(<span class="string">"编号："</span> + code  + <span class="string">"正在执行\""</span> + opertion +<span class="string">"\"操作"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>然后是抽象出每个操作：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.hulala.jmt.pc1;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Operation</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(ElectronicComponent ec)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>因为这边的操作是个抽象概念，并不涉及某个实际内容，所以只需声明函数签名，无需实现函数体，故使用抽象方法（在C++中为虚函数）。</p><p>现在已经抽象出不同点了，下面就要继续实现各个模块共同点，共同点由三个：入口、出口、传送带，抽象出来就是数据接收、数据产生、缓冲区(<em>BlockingQueue</em>)，可见这就是一个典型的生产者消费者模型：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.hulala.jmt.pc1;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Operation</span> </span>&#123;</div><div class="line">	<span class="comment">// 缓冲区</span></div><div class="line">	<span class="keyword">private</span> BlockingQueue&lt;ElectronicComponent&gt; queue;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Operation</span><span class="params">()</span> </span>&#123;</div><div class="line">		queue = <span class="keyword">new</span> BlockingQueue&lt;ElectronicComponent&gt;();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 数据接收</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> ec</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(ElectronicComponent ec)</span> </span>&#123;</div><div class="line">		queue.offer(ec);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 数据传送</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> oper</div><div class="line">	 * <span class="doctag">@param</span> ec</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Operation oper, ElectronicComponent ec)</span> </span>&#123;</div><div class="line">		oper.receive(ec);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>现在一个模块的骨架基本完成了，但是光这样还不够，上面说了：生产者消费者模式运行起来是个是个持续过程，所以我们要有一个线程，确保模块接收数据同时可以执行操作：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doOperation</span><span class="params">(Operation oper)</span> </span>&#123;</div><div class="line">  Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      ElectronicComponent ec = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">if</span> ((ec = queue.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">        operation(ec);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != oper)</div><div class="line">          send(oper, ec);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">  thread.setDaemon(<span class="keyword">false</span>);</div><div class="line">  thread.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p><strong>doOperation</strong>目的很明确，启动一个线程，循环从队列中取出数据，执行该模块的operation操作，执行完后传送给下一个模块；<br>现在一个抽象的操作模块已经基本完成，可以具体实现流水线的4个操作了：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">DaMo.java</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaMo</span> <span class="keyword">extends</span> <span class="title">Operation</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(ElectronicComponent ec)</span> </span>&#123;</div><div class="line">		ec.status(<span class="string">"打磨"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PaoGuang.java</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaoGuang</span> <span class="keyword">extends</span> <span class="title">Operation</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(ElectronicComponent ec)</span> </span>&#123;</div><div class="line">		ec.status(<span class="string">"抛光"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">HanJie.java</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HanJie</span> <span class="keyword">extends</span> <span class="title">Operation</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(ElectronicComponent ec)</span> </span>&#123;</div><div class="line">		ec.status(<span class="string">"焊接"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ZhiJian.java</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZhiJian</span> <span class="keyword">extends</span> <span class="title">Operation</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(ElectronicComponent ec)</span> </span>&#123;</div><div class="line">		ec.status(<span class="string">"质检"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>写了那么多，终于可以测试一下看看了:<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//App2.java</span></div><div class="line"><span class="keyword">package</span> com.hulala.jmt.pc1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.hulala.jmt.pc1.operation.DaMo;</div><div class="line"><span class="keyword">import</span> com.hulala.jmt.pc1.operation.HanJie;</div><div class="line"><span class="keyword">import</span> com.hulala.jmt.pc1.operation.Operation;</div><div class="line"><span class="keyword">import</span> com.hulala.jmt.pc1.operation.PaoGuang;</div><div class="line"><span class="keyword">import</span> com.hulala.jmt.pc1.operation.ZhiJian;</div><div class="line"><span class="keyword">import</span> com.hulala.jmt.pc1.pojo.ElectronicComponent;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App2</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Operation damo = <span class="keyword">new</span> DaMo();</div><div class="line">		Operation paoguang = <span class="keyword">new</span> PaoGuang();</div><div class="line">		Operation hanjie = <span class="keyword">new</span> HanJie();</div><div class="line">		Operation zhijian = <span class="keyword">new</span> ZhiJian();</div><div class="line">		zhijian.doOperation(<span class="keyword">null</span>);</div><div class="line">		hanjie.doOperation(zhijian);</div><div class="line">		paoguang.doOperation(hanjie);</div><div class="line">		damo.doOperation(paoguang);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i != <span class="number">5</span>; ++i) &#123;</div><div class="line">			damo.receive(<span class="keyword">new</span> ElectronicComponent(i));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>运行以上main方法，看控制台输出：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">编号：1正在执行&quot;打磨&quot;操作</div><div class="line">编号：2正在执行&quot;打磨&quot;操作</div><div class="line">编号：0正在执行&quot;抛光&quot;操作</div><div class="line">编号：3正在执行&quot;打磨&quot;操作</div><div class="line">编号：4正在执行&quot;打磨&quot;操作</div><div class="line">编号：0正在执行&quot;焊接&quot;操作</div><div class="line">编号：1正在执行&quot;抛光&quot;操作</div><div class="line">编号：0正在执行&quot;质检&quot;操作</div><div class="line">编号：2正在执行&quot;抛光&quot;操作</div><div class="line">编号：1正在执行&quot;焊接&quot;操作</div><div class="line">编号：3正在执行&quot;抛光&quot;操作</div><div class="line">编号：1正在执行&quot;质检&quot;操作</div><div class="line">编号：2正在执行&quot;焊接&quot;操作</div><div class="line">编号：4正在执行&quot;抛光&quot;操作</div><div class="line">编号：3正在执行&quot;焊接&quot;操作</div><div class="line">编号：2正在执行&quot;质检&quot;操作</div><div class="line">编号：4正在执行&quot;焊接&quot;操作</div><div class="line">编号：3正在执行&quot;质检&quot;操作</div><div class="line">编号：4正在执行&quot;质检&quot;操作</div></pre></td></tr></table></figure><p></p><p>因为是多个线程异步执行，所以每次运行打出顺序可能会不一样。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到此为止，一个完整的流水线算是初步完成了，在上面分析及设计过程中：</p><ul><li>封装对象的共同点，抽象对象的不同点是程序设计实现一个非常好的思路；</li><li>我们都用到了面向对象的三个基本特征：继承、封装、多态，类图关系如下：<img src="http://www.plantuml.com/plantuml/svg/XP2z2i9G38Nd-XGP5RNWBWx-e0YYhcun3VNgRLBRMn5AtrrhjOeepP3bV3avd1ZfX243QUGVCeiM_MFa_9W6liQSe3CgUGlkW_lK9KWEo6AQmlgbGYMNqnzRfPEHS9jnniEPPNA9Yg69Hh4AYnl1kPJgYsx-iYtgT-qVTy3KQNbUzw8cW8I9pOKRkK3haErttFBFcqbPWY-n1_-C7x6BnwvAcE9AWQ_kRlBHIFxal0hQeCupbB0HNA0i3JTYkuDP6fJ_N743"></li><li>生产者消费者模式是我们在多线程编程当中经常碰到的问题，掌握该模式足以让我们应付绝大多数多个线程之间数据交互的问题。</li></ul><p>以上代码未考虑缓冲区溢出，省略了异常捕获，要真正用于生产环境这些都是要考略的。</p><h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p>完整代码的Github项目地址：<em><a href="https://github.com/hulala1021/producer-consumer" target="_blank" rel="external">producer-consumer</a></em><br>&ensp;<br></p><div style="text-align:center"><div class="github-card" data-user="" data-repo="" data-width="400" data-theme="default" data-target="" data-client-id="" data-client-secret=""></div></div><script src="/github-card-lib/githubcard.js"></script><br>&ensp;<p></p><p>本文永久链接： <a href="http://doornote.net/2016/07/17/java-multithreading-1/">http://doornote.net/2016/07/17/java-multithreading-1/</a> ；欢迎转载。</p></div><div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Java/" rel="tag">#Java</a> <a href="/tags/多线程编程/" rel="tag">#多线程编程</a> <a href="/tags/生产者消费者问题/" rel="tag">#生产者消费者问题</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2016/07/14/win32-gluttony-snake/" rel="next" title="利用Win32Api实现的一个简单的贪食蛇游戏"><i class="fa fa-chevron-left"></i> 利用Win32Api实现的一个简单的贪食蛇游戏</a></div><div class="post-nav-prev post-nav-item"><a href="/2016/07/20/productivity-tool-recommend/" rel="prev" title="程序员生产力工具推荐">程序员生产力工具推荐 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div class="jiathis_style"><a class="jiathis_button_tsina"></a> <a class="jiathis_button_tqq"></a> <a class="jiathis_button_weixin"></a> <a class="jiathis_button_cqq"></a> <a class="jiathis_button_douban"></a> <a class="jiathis_button_renren"></a> <a class="jiathis_button_qzone"></a> <a class="jiathis_button_kaixin001"></a> <a class="jiathis_button_copy"></a> <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a> <a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script></div></div></div><div class="comments" id="comments"><div class="ds-thread" data-thread-key="2016/07/17/java-multithreading-1/" data-title="JAVA多线程编程——生产者消费者模式(1)" data-url="http://doornote.net/2016/07/17/java-multithreading-1/"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="崔伟"><p class="site-author-name" itemprop="name">崔伟</p><p class="site-description motion-element" itemprop="description">寻求简洁自然的编程方式。。。</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">5</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags"><span class="site-state-item-count">12</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/hulala1021" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub </a></span><span class="links-of-author-item"><a href="http://steamcommunity.com/id/hulala1021/" target="_blank" title="Steam"><i class="fa fa-fw fa-steam-square"></i> Steam</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#生产者消费者问题简述"><span class="nav-number">1.</span> <span class="nav-text">生产者消费者问题简述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#阻塞队列"><span class="nav-number">2.</span> <span class="nav-text">阻塞队列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#简单的泛型阻塞队列的实现"><span class="nav-number">3.</span> <span class="nav-text">简单的泛型阻塞队列的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生产者消费者模式初步实现"><span class="nav-number">4.</span> <span class="nav-text">生产者消费者模式初步实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#进阶"><span class="nav-number">5.</span> <span class="nav-text">进阶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Github"><span class="nav-number">7.</span> <span class="nav-text">Github</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2017</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">崔伟</span></div><div class="powered-by">由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info">主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span> <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script><script type="text/javascript">var duoshuoQuery={short_name:"hulala1021"};!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.id="duoshuo-script",t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()</script><script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script><script src="/js/src/hook-duoshuo.js"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),i=r.url,o=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){o=s.indexOf(e),l=n.indexOf(e),o<0&&l<0?c=!1:(l<0&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+i+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>